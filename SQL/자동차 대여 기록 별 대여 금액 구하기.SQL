-- 자동차 대여 기록 별 대여 금액 구하기
SELECT H.HISTORY_ID, IF(P.DISCOUNT_RATE IS NULL, LENTAL_DATE * CAR.DAILY_FEE,
                        ROUND(CAR.DAILY_FEE - (CAR.DAILY_FEE * (P.DISCOUNT_RATE / 100)))
                        * H.LENTAL_DATE) AS FEE

FROM CAR_RENTAL_COMPANY_CAR AS CAR,
(SELECT CAR_ID, HISTORY_ID, TIMESTAMPDIFF(DAY,START_DATE, END_DATE) + 1 AS LENTAL_DATE,
 CASE WHEN TIMESTAMPDIFF(DAY, START_DATE, END_DATE) + 1 >= 90 THEN "90일 이상"
 WHEN TIMESTAMPDIFF(DAY, START_DATE, END_DATE) + 1 >= 30 THEN "30일 이상"
 WHEN TIMESTAMPDIFF(DAY, START_DATE, END_DATE) + 1 >= 7 THEN "7일 이상"
 END AS DURATION_TYPE FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY) AS H

LEFT JOIN(SELECT DURATION_TYPE, DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
          WHERE CAR_TYPE = '트럭') AS P ON H.DURATION_TYPE = P.DURATION_TYPE

WHERE CAR.CAR_ID = H.CAR_ID and CAR.CAR_TYPE = '트럭'
ORDER BY FEE DESC, H.HISTORY_ID DESC

-- 두번째 방법
-- SELECT CH.HISTORY_ID, 
--        ROUND((CASE WHEN DATEDIFF(CH.END_DATE, CH.START_DATE)+1 < 7
--             THEN (DATEDIFF(CH.END_DATE, CH.START_DATE)+1) * CR.DAILY_FEE
--             WHEN DATEDIFF(CH.END_DATE, CH.START_DATE)+1 < 30
--             THEN (DATEDIFF(CH.END_DATE, CH.START_DATE)+1) * CR.DAILY_FEE * 0.95
--             WHEN DATEDIFF(CH.END_DATE, CH.START_DATE)+1 < 90
--             THEN (DATEDIFF(CH.END_DATE, CH.START_DATE)+1) * CR.DAILY_FEE * 0.92
--             ELSE (DATEDIFF(CH.END_DATE, CH.START_DATE)+1) * CR.DAILY_FEE * 0.85
--         END),0) AS FEE
--   FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY CH, CAR_RENTAL_COMPANY_CAR CR, CAR_RENTAL_COMPANY_DISCOUNT_PLAN CP
--   WHERE CR.CAR_TYPE = CP.CAR_TYPE AND CR.CAR_ID = CH.CAR_ID
--         AND CR.CAR_TYPE = '트럭' and CP.CAR_TYPE = '트럭'
--   GROUP BY CH.HISTORY_ID
--   ORDER BY FEE DESC, CH.HISTORY_ID DESC